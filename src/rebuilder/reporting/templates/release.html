{% extends "base.html" %}

{% block title %}{{ version }} - OpenWrt Reproducible Build Results{% endblock %}

{% block hero %}
<div class="hero-section">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="index.html" class="text-white-50">All Releases</a></li>
                <li class="breadcrumb-item active text-white" aria-current="page">{{ version }}</li>
            </ol>
        </nav>
        <h1 class="mb-2">OpenWrt {{ version }}</h1>
        <p class="lead mb-0 opacity-75">Reproducible Build Results</p>
    </div>
</div>
{% endblock %}

{% block content %}
{% if version_stats %}
{% set total = version_stats.good + version_stats.bad + version_stats.unknown %}
{% set percent = (version_stats.good / total * 100) if total > 0 else 0 %}

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="card-title mb-3">Release Overview</h5>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ percent | round(1) }}%">
                                {{ percent | round(1) }}% GOOD
                            </div>
                        </div>
                        <p class="text-muted mb-0">{{ version_stats.good }} of {{ total }} artifacts are reproducible across {{ targets | length }} target{{ 's' if targets | length != 1 else '' }}</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <span class="percentage-display text-success">{{ percent | round(1) }}%</span>
                        <span class="d-block text-muted">Reproducible</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if history and history.entries | length > 1 %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up me-2"></i>Reproducibility Timeline
            </div>
            <div class="card-body">
                <canvas id="timeline-chart" height="100"></canvas>
                <p class="text-muted small mt-2 mb-0">
                    Showing {{ history.entries | length }} historical builds.
                    {% if 'SNAPSHOT' in version %}
                    Each point represents a different OpenWrt commit.
                    {% else %}
                    Each point represents a rebuild of the same release.
                    {% endif %}
                </p>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-4">
        <div class="stat-card status-good-subtle">
            <div class="stat-value text-success">{{ version_stats.good }}</div>
            <div class="stat-label text-success">GOOD</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card status-bad-subtle">
            <div class="stat-value text-danger">{{ version_stats.bad }}</div>
            <div class="stat-label text-danger">BAD</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="stat-card status-unknown-subtle">
            <div class="stat-value text-warning">{{ version_stats.unknown }}</div>
            <div class="stat-label text-warning">UNKNOWN</div>
        </div>
    </div>
</div>
{% endif %}

<h4 class="mb-3">
    <i class="bi bi-bullseye me-2"></i>Targets
    <span class="badge bg-secondary">{{ targets | length }}</span>
</h4>

<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for target, target_data in targets.items() %}
    {% set stats = target_data.stats %}
    {% set t_total = stats.good + stats.bad + stats.unknown %}
    {% set t_percent = (stats.good / t_total * 100) if t_total > 0 else 0 %}
    {% set target_slug = target | replace('/', '_') %}
    <div class="col">
        <div class="card h-100">
            <div class="card-header">
                <a href="{{ release_dir }}/{{ target_slug }}.html" class="text-decoration-none text-dark">
                    <i class="bi bi-cpu me-2"></i>{{ target }}
                </a>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ t_percent | round(1) }}%">
                        {{ t_percent | round(1) }}%
                    </div>
                </div>
                <div class="row text-center g-2">
                    <div class="col-4">
                        <span class="badge status-good w-100 py-2">
                            <span class="d-block fs-5">{{ stats.good }}</span>
                            <small>GOOD</small>
                        </span>
                    </div>
                    <div class="col-4">
                        <span class="badge status-bad w-100 py-2">
                            <span class="d-block fs-5">{{ stats.bad }}</span>
                            <small>BAD</small>
                        </span>
                    </div>
                    <div class="col-4">
                        <span class="badge status-unknown w-100 py-2">
                            <span class="d-block fs-5">{{ stats.unknown }}</span>
                            <small>UNKWN</small>
                        </span>
                    </div>
                </div>
            </div>
            <div class="card-footer bg-transparent">
                <a href="{{ release_dir }}/{{ target_slug }}.html" class="btn btn-sm btn-outline-primary w-100">
                    View Details <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_scripts %}
{% if history and history.entries | length > 1 %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
(function() {
    const historyData = {{ history_json | safe }};
    if (!historyData || !historyData.entries || historyData.entries.length < 2) return;

    // Reverse to show oldest to newest (left to right)
    const entries = [...historyData.entries].reverse();

    // Prepare data for the chart
    const labels = entries.map(e => {
        if (e.version_code) {
            // For SNAPSHOT: show version code (e.g., r28532)
            return e.version_code.split('-')[0];
        } else {
            // For releases: show date
            const date = new Date(e.timestamp);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
    });

    const percentages = entries.map(e => {
        const total = e.stats.good + e.stats.bad + e.stats.unknown;
        return total > 0 ? (e.stats.good / total * 100).toFixed(1) : 0;
    });

    const goodCounts = entries.map(e => e.stats.good);
    const badCounts = entries.map(e => e.stats.bad);
    const unknownCounts = entries.map(e => e.stats.unknown);

    const ctx = document.getElementById('timeline-chart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '% Reproducible',
                data: percentages,
                borderColor: '#198754',
                backgroundColor: 'rgba(25, 135, 84, 0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            const idx = context[0].dataIndex;
                            const entry = entries[idx];
                            if (entry.version_code) {
                                return 'Commit: ' + entry.version_code;
                            }
                            return new Date(entry.timestamp).toLocaleString();
                        },
                        afterLabel: function(context) {
                            const idx = context.dataIndex;
                            const entry = entries[idx];
                            return [
                                'Good: ' + entry.stats.good,
                                'Bad: ' + entry.stats.bad,
                                'Unknown: ' + entry.stats.unknown
                            ];
                        }
                    }
                }
            },
            scales: {
                y: {
                    min: 0,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 0
                    }
                }
            }
        }
    });
})();
</script>
{% endif %}
{% endblock %}
