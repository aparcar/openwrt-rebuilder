name: Rebuild OpenWrt

on:
  workflow_dispatch:
    inputs:
      version:
        description: "OpenWrt version to build (e.g., SNAPSHOT, 25.12.0-rc2, 23.05.5)"
        required: false
        default: "SNAPSHOT"
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.inputs.version || 'SNAPSHOT' }}
  cancel-in-progress: true

jobs:
  build:
    name: ${{ github.event.inputs.version || 'SNAPSHOT' }} - ${{ matrix.target }}
    runs-on: self-hosted
    strategy:
      fail-fast: False
      matrix:
        target:
          # - "mediatek/filogic"
          - "x86/64"
          # - "x86/generic"
    env:
      VERSION: ${{ github.event.inputs.version || 'SNAPSHOT' }}
    steps:
      - name: Verify that podman works
        run: podman run --rm alpine echo "Podman is working"

      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Cache OpenWrt git repository
        uses: actions/cache@v5
        with:
          path: ./build/${{ env.VERSION }}/.git
          key: openwrt-git-${{ env.VERSION }}-${{ github.sha }}
          restore-keys: |
            openwrt-git-${{ env.VERSION }}-
            openwrt-git-

      - name: Cache downloads
        uses: actions/cache@v5
        with:
          path: ./build/${{ env.VERSION }}/dl
          key: openwrt-dl-${{ env.VERSION }}-${{ hashFiles('**/feeds.conf*', '**/feeds.buildinfo*') }}
          restore-keys: |
            openwrt-dl-${{ env.VERSION }}-
            openwrt-dl-

      - name: Cache feeds
        uses: actions/cache@v5
        with:
          path: |
            ./build/${{ env.VERSION }}/feeds
            ./build/${{ env.VERSION }}/package/feeds
          key: openwrt-feeds-${{ env.VERSION }}-${{ hashFiles('**/feeds.conf*', '**/feeds.buildinfo*') }}
          restore-keys: |
            openwrt-feeds-${{ env.VERSION }}-
            openwrt-feeds-

      - name: Run rebuilder on ${{ matrix.target }}
        run: uv run openwrt-rebuilder
        env:
          TARGET: ${{ matrix.target }}
          USE_DIFFOSCOPE: True

      - name: Slug target name
        if: always()
        run: echo "target_slug=$(echo ${{ matrix.target }} | tr '/' '_')" >> "$GITHUB_ENV"

      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: results-${{ env.VERSION }}-${{ env.target_slug }}
          path: results/

  overview:
    name: Generate Overview
    runs-on: ubuntu-latest
    needs: build
    if: always()

    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Checkout gh-pages
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: results-*
          path: results/
          merge-multiple: true

      - name: Combine results and generate hierarchical overview
        run: |
          # Copy existing gh-pages content as base (if exists)
          if [ -d gh-pages ]; then
            mkdir -p combined_results
            cp -r gh-pages/* combined_results/ 2>/dev/null || true
            rm -rf combined_results/.git
          fi
          # Merge new results on top
          uv run openwrt-rebuilder combine --results-dir results --output-dir combined_results

      - name: Publish to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: combined_results/
          force_orphan: true
